# DBandKBsem2

Система реализует «эстафету с центральным координатором»: один процесс‑рефери инициирует раунд по команде из Telegram‑чата, собирает готовых участников через Redis, объявляет порядок и даёт старт; участники по очереди отправляют сообщения в заданный топик чата.

## Схема

- Рефери
  - Следит за чатом и реагирует на фразу «начинаю эстафету».
  - Публикует в Redis клич о готовности участников.
  - Собирает UUID участников, формирует очередь, объявляет её в чате и запускает эстафету.
- Участники
  - Подписаны на Redis‑канал.
  - Отвечают на клич готовности.
  - По своей очереди отправляют сообщение в чат и завершают участие в раунде.

## Требования

- Python 3.9+
- Доступ к Redis (host/port)
- Токен Telegram‑бота для отправки сообщений в чат (HTTP Bot API)
- Данные Telegram API (api_id, api_hash) для рефери (чтение чата)
- ID чата и ID топика (message_thread_id), куда писать

## Установка

1) Подготовка окружения
- `python -m venv venv`
- `source venv/bin/activate`
- `pip install -r requirements.txt`

2) Настройки
- В `referee.py` указать `API_ID`, `API_HASH`, `TOKEN`, `CHAT_ID`, `TOPIC_ID`, параметры Redis.
- В `participant.py` указать `TOKEN`, `CHAT_ID`, `TOPIC_ID`, параметры Redis.
- Примечание: `config.py` нужен только для бота отладки.

3) Проверка Redis
- Убедиться, что Redis доступен по указанным `host/port`.

## Как это работает

- Триггер: сообщение «начинаю эстафету» в целевом чате/топике.
- Рефери:
  - Очищает служебные ключи Redis для нового раунда.
  - Публикует `roll_call` в Redis‑канале.
  - За отведённое время собирает ответы участников в множестве Redis.
  - Формирует очередь, объявляет её в чате, публикует `start_race` с массивом `order`.
- Участники:
  - На `roll_call` добавляют свой UUID в множество готовых.
  - На `start_race` находят свой номер в `order`, ждут очереди и отправляют сообщение в чат.

## Запуск

1) Участники (каждый на своём ноутбуке)
- `source venv/bin/activate`
- `python participant.py`

Скрипт сгенерирует UUID и подпишется на Redis‑канал.

2) Рефери
- `source venv/bin/activate`
- `python referee.py`

При первом запуске потребуется авторизация Telegram‑клиента рефери.

3) Старт раунда
- В целевом чате отправить: `начинаю эстафету`
- Рефери объявит порядок и автоматически запустит эстафету.

## Формат сообщений в Redis

- Клич готовности
  - `{ "type": "roll_call" }`
- Старт раунда
  - `{ "type": "start_race", "order": ["bot-xxxxxx", "bot-yyyyyy", "..."] }`

Участники реагируют только на `roll_call` и `start_race`, общение с чатом — через HTTP Bot API.

## Перезапуск раунда

- Достаточно снова отправить в чат «начинаю эстафету» — рефери очистит служебные ключи и начнёт новый сбор готовых.
